<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Particle Art System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #000000;
            overflow: hidden;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #000000;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            color: white;
            max-width: 320px;
            backdrop-filter: blur(10px);
            z-index: 100;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #00ff88;
        }
        
        h1 {
            font-size: 18px;
            color: #00ff88;
            margin-bottom: 15px;
            text-align: center;
        }
        
        h2 {
            font-size: 14px;
            margin: 20px 0 10px 0;
            color: #00ff88;
            border-bottom: 1px solid #00ff88;
            padding-bottom: 5px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #ccc;
        }
        
        select, input[type="color"], input[type="range"] {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
        }
        
        select {
            font-size: 14px;
        }
        
        input[type="color"] {
            height: 40px;
        }
        
        input[type="range"] {
            padding: 0;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: scale(1.05);
        }
        
        .info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid #00ff88;
        }
        
        .json-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border: 1px solid #00ff88;
        }
        
        .json-display pre {
            margin: 0;
            white-space: pre-wrap;
        }
        
        .status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff88;
            font-size: 16px;
            font-family: monospace;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ff88;
            display: none;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="status" class="status">Loading Three.js...</div>
    
    <div id="controls">
        <h1>üåü 3D Particle Art</h1>
        
        <h2>üé® Controls</h2>
        
        <div class="control-group">
            <label>Particle Type</label>
            <select id="particle-type">
                <option value="snowflake">‚õÑ Snowflake</option>
                <option value="smoke">üí® Smoke</option>
                <option value="firework">üéÜ Firework</option>
                <option value="sphere">üîµ Sphere</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Color</label>
            <input type="color" id="color-picker" value="#ffffff">
        </div>
        
        <div class="control-group">
            <label>Count: <span id="count-value">10000</span></label>
            <input type="range" id="particle-count" min="1000" max="20000" value="10000" step="1000">
        </div>
        
        <div class="control-group">
            <label>Size: <span id="size-value">0.5</span></label>
            <input type="range" id="particle-size" min="0.1" max="1.5" value="0.5" step="0.05">
        </div>
        
        <div class="control-group">
            <label>Speed: <span id="speed-value">0.02</span></label>
            <input type="range" id="particle-speed" min="0.01" max="0.2" value="0.02" step="0.01">
        </div>
        
        <button id="export-json">üíæ Export JSON</button>
    </div>
    
    <div class="json-display">
        <h3 style="margin-bottom: 10px; color: #fff;">Current Config</h3>
        <pre id="json-content"></pre>
    </div>
    
    <div class="info">
        <div>üñ±Ô∏è Drag to rotate</div>
        <div>üîç Scroll to zoom</div>
        <div style="margin-top: 10px; color: #00ff88;">‚ú® Working Version</div>
    </div>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        const statusDiv = document.getElementById('status');
        statusDiv.style.display = 'block';
        
        try {
            // Import Three.js
            statusDiv.textContent = 'Loading Three.js...';
            const THREE = await import('three');
            
            statusDiv.textContent = 'Loading OrbitControls...';
            const { OrbitControls } = await import('three/addons/controls/OrbitControls.js');
            
            statusDiv.textContent = 'Initializing...';
            
            console.log('üöÄ System starting...');
            
            // Particle configs
            const particleConfigs = {
                snowflake: {
                    type: 'snowflake',
                    count: 10000,
                    color: '#ffffff',
                    size: 0.5,
                    speed: 0.02,
                    opacity: 0.9
                },
                smoke: {
                    type: 'smoke',
                    count: 12000,
                    color: '#cccccc',
                    size: 0.6,
                    speed: 0.03,
                    opacity: 0.6
                },
                firework: {
                    type: 'firework',
                    count: 8000,
                    color: '#ff00ff',
                    size: 0.5,
                    speed: 0.08,
                    opacity: 1.0
                },
                sphere: {
                    type: 'sphere',
                    count: 15000,
                    color: '#00ffff',
                    size: 0.4,
                    speed: 0.1,
                    opacity: 0.95
                }
            };
            
            let scene, camera, renderer, controls;
            let particles = null;
            let currentConfig = { ...particleConfigs.snowflake };
            let time = 0;
            
            function init() {
                // Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000);
                
                // Camera
                camera = new THREE.PerspectiveCamera(
                    75,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    1000
                );
                camera.position.set(0, 0, 15);
                
                // Renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.getElementById('canvas-container').appendChild(renderer.domElement);
                
                // Controls
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.minDistance = 5;
                controls.maxDistance = 40;
                
                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
                scene.add(ambientLight);
                
                // Create particles
                createParticles();
                
                // Setup controls
                setupControls();
                
                // Handle resize
                window.addEventListener('resize', onWindowResize);
                
                // Animate
                animate();
                
                // Hide status
                statusDiv.style.display = 'none';
                
                console.log('‚úÖ System initialized!');
                updateJSON();
            }
            
            function createParticles() {
                if (particles) {
                    scene.remove(particles);
                    particles.geometry.dispose();
                    particles.material.dispose();
                }
                
                const count = currentConfig.count;
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(count * 3);
                const velocities = new Float32Array(count * 3);
                
                for (let i = 0; i < count; i++) {
                    const i3 = i * 3;
                    positions[i3] = (Math.random() - 0.5) * 20;
                    positions[i3 + 1] = (Math.random() - 0.5) * 20;
                    positions[i3 + 2] = (Math.random() - 0.5) * 20;
                    
                    velocities[i3] = (Math.random() - 0.5) * 0.1;
                    velocities[i3 + 1] = (Math.random() - 0.5) * 0.1;
                    velocities[i3 + 2] = (Math.random() - 0.5) * 0.1;
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('velocity', new THREE.BufferAttribute(velocities, 3));
                
                const material = new THREE.PointsMaterial({
                    color: new THREE.Color(currentConfig.color),
                    size: currentConfig.size,
                    sizeAttenuation: true,
                    transparent: true,
                    opacity: currentConfig.opacity,
                    depthWrite: false,
                    blending: currentConfig.type === 'firework' ? THREE.AdditiveBlending : THREE.NormalBlending
                });
                
                particles = new THREE.Points(geometry, material);
                scene.add(particles);
                
                console.log(`‚úÖ Created ${count} particles`);
            }
            
            function updateParticles() {
                if (!particles) return;
                
                time += 0.01;
                const positions = particles.geometry.attributes.position.array;
                const velocities = particles.geometry.attributes.velocity.array;
                const speed = currentConfig.speed;
                
                for (let i = 0; i < positions.length; i += 3) {
                    switch (currentConfig.type) {
                        case 'snowflake':
                            positions[i + 1] -= speed;
                            positions[i] += Math.sin(time + i * 0.01) * 0.002;
                            if (positions[i + 1] < -10) positions[i + 1] = 10;
                            break;
                            
                        case 'smoke':
                            positions[i + 1] += speed;
                            positions[i] += velocities[i] * 0.02;
                            positions[i + 2] += velocities[i + 2] * 0.02;
                            if (positions[i + 1] > 10) positions[i + 1] = -10;
                            break;
                            
                        case 'firework':
                            positions[i] += velocities[i] * speed * 2;
                            positions[i + 1] += velocities[i + 1] * speed * 2 - 0.003;
                            positions[i + 2] += velocities[i + 2] * speed * 2;
                            const dist = Math.sqrt(
                                positions[i] ** 2 + 
                                positions[i + 1] ** 2 + 
                                positions[i + 2] ** 2
                            );
                            if (dist > 10) {
                                positions[i] = velocities[i] * 0.1;
                                positions[i + 1] = velocities[i + 1] * 0.1;
                                positions[i + 2] = velocities[i + 2] * 0.1;
                            }
                            break;
                            
                        case 'sphere':
                            const angle = time * speed;
                            const radius = Math.sqrt(positions[i] ** 2 + positions[i + 2] ** 2);
                            positions[i] = radius * Math.cos(angle + i * 0.01);
                            positions[i + 2] = radius * Math.sin(angle + i * 0.01);
                            break;
                    }
                }
                
                particles.geometry.attributes.position.needsUpdate = true;
            }
            
            function setupControls() {
                const typeSelect = document.getElementById('particle-type');
                const colorPicker = document.getElementById('color-picker');
                const countSlider = document.getElementById('particle-count');
                const sizeSlider = document.getElementById('particle-size');
                const speedSlider = document.getElementById('particle-speed');
                const exportBtn = document.getElementById('export-json');
                
                typeSelect.addEventListener('change', (e) => {
                    const newConfig = { ...particleConfigs[e.target.value] };
                    newConfig.count = currentConfig.count;
                    newConfig.size = currentConfig.size;
                    newConfig.speed = currentConfig.speed;
                    currentConfig = newConfig;
                    createParticles();
                    colorPicker.value = currentConfig.color;
                    updateJSON();
                });
                
                colorPicker.addEventListener('input', (e) => {
                    currentConfig.color = e.target.value;
                    if (particles) {
                        particles.material.color = new THREE.Color(e.target.value);
                    }
                    updateJSON();
                });
                
                countSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    document.getElementById('count-value').textContent = value;
                    currentConfig.count = value;
                    createParticles();
                    updateJSON();
                });
                
                sizeSlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    document.getElementById('size-value').textContent = value;
                    currentConfig.size = value;
                    if (particles) {
                        particles.material.size = value;
                    }
                    updateJSON();
                });
                
                speedSlider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    document.getElementById('speed-value').textContent = value;
                    currentConfig.speed = value;
                    updateJSON();
                });
                
                exportBtn.addEventListener('click', () => {
                    const dataStr = JSON.stringify(currentConfig, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', `particle-config-${currentConfig.type}.json`);
                    linkElement.click();
                });
            }
            
            function updateJSON() {
                document.getElementById('json-content').textContent = JSON.stringify(currentConfig, null, 2);
            }
            
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                updateParticles();
                renderer.render(scene, camera);
            }
            
            init();
            
        } catch (error) {
            statusDiv.textContent = '‚ùå Error: ' + error.message;
            statusDiv.style.color = '#f00';
            console.error('Error:', error);
        }
    </script>
</body>
</html>